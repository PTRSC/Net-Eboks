#!perl
use strict;
use warnings;
use Config;

my $tmp  = ($ENV{TEMP} // '.')."/install-$$.bat";
my $cmd = $Config{sitebin} . "/eboks2pop-win32.cmd";

my $what = $ARGV[0] // 'install';

if ($what eq 'install') {
	open F, ">", $cmd or die $!;
	print F '@start /b wperl "' . $Config{sitebin} . '/eboks2pop" -p 8110' . "\n";
	close F;

	my $ps = <<PS;
set TARGET='$cmd'
set SHORTCUT='%userprofile%\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\eboks2pop.lnk'
set PWS=powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile

%PWS% -Command "\$ws = New-Object -ComObject WScript.Shell; \$s = \$ws.CreateShortcut(%SHORTCUT%); \$S.TargetPath = %TARGET%; \$S.Save()"
PS

	open F, ">", $tmp or die $!;
	print F $ps;
	close F;
	system $tmp and die "Error";
	unlink $tmp;

	print "\n\nLOOKS OKAY\n";

	$|++;
	while ( 1 ) {
		print "Do you want to authenticate with NemID now? [n] ";
		$_ = lc <>;
		chomp;
		if ($_ eq 'n' or $_ eq '') {
			print "You can always run it later by running 'eboks-authenticate'\n";
			exit;
		}
		last if $_ eq 'y';
	}
	print "Starting browser..\n";
	system 'start /b http://localhost:9999/';
	print "You can close [x] this window after NemID auth is completed or you want to abort the process\n\n";
	print "Starting authenticator...\n";
	system 'eboks-authenticate' and die "Cannot run eboks-authenticate:$!\n";
} elsif ( $what eq 'start') {
	system $cmd;
} elsif ( $what eq 'remove') {
	unlink "$ENV{userprofile}\\AppData\\Roaming\\Microsoft\\Windows\\Start Menu\\Programs\\Startup\\eboks2pop.lnk" or die "Cannot remove:$!";
	print "Removed okay\n";
} else {
	die "Nothing to do";
}
